include:
  - project: 'carpinion/ci/templates'
    file: 'vanilla-helm.yaml'

build:
  script:
    - helm repo add stable https://kubernetes-charts.storage.googleapis.com/
    - helm repo add incubator https://kubernetes-charts-incubator.storage.googleapis.com/
    - helm repo add riskfocus https://riskfocus.github.io/helm-charts-public/
    - helm repo add touk $CHARTS_PUBLIC_RELEASES_URL
    - helm repo add touk-private $CHARTS_PRIVATE_RELEASES_URL
    - helm repo add touk-snapshots $CHARTS_PRIVATE_SNAPSHOTS_URL
    - helm repo add influxdata https://helm.influxdata.com/
    - helm dependencies build ./src
    - helm package ./src -d dist --version $VERSION

deploy:
  services:
    - docker:dind
  script:
    - kubectl get secret "$CI_ENVIRONMENT_SLUG-postgresql" || kubectl create secret generic "$CI_ENVIRONMENT_SLUG-postgresql" --from-literal postgresql-password=`date +%s | sha256sum | base64 | head -c 32`
    - kubectl create configmap "$CI_ENVIRONMENT_SLUG-telegraf-configuration" --from-file=telegraf.conf -o yaml --dry-run | kubectl replace -n "$KUBE_NAMESPACE" --force -f -
    - |
      helm upgrade -i --wait --devel "$CI_ENVIRONMENT_SLUG" touk/$NAME --version $VERSION \
        --set postgresql.existingSecret="$CI_ENVIRONMENT_SLUG-postgresql" \
        --set telegraf.volumes[0].configMap.name="$CI_ENVIRONMENT_SLUG-telegraf-configuration" \
        -f deploy-values.yaml
